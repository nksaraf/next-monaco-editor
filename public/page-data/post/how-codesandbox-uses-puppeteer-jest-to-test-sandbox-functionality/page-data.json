{"componentChunkName":"component---src-templates-post-js","path":"/post/how-codesandbox-uses-puppeteer-jest-to-test-sandbox-functionality","webpackCompilationHash":"43a07f76784e304bf1a0","result":{"data":{"blogPost":{"fields":{"authors":["Ives van Hoorne"],"date":"2018-02-22T00:00:00.000Z","description":"CodeSandbox uses Puppeteer extensively, in this post we will explain how we use Jest & Puppeteer to test user written code.","photo":"https://avatars0.githubusercontent.com/u/587016?s=460&v=4","slug":"how-codesandbox-uses-puppeteer-jest-to-test-sandbox-functionality","title":"How CodeSandbox uses Puppeteer & Jest to test sandbox functionality"},"frontmatter":{"banner":{"publicURL":"/static/banner-3b6a60141f6bf6f4c263dd2ba95f401a.png"}},"html":"<p>Last year a tool called '<a href=\"https://github.com/GoogleChrome/puppeteer\">Puppeteer</a>'\nwas released by the <a href=\"https://twitter.com/ChromiumDev\">Chrome Developers</a> team.\nThis tool is a headless <a href=\"https://google.com/chrome\">Chrome</a>, which means that\nwith it you can interact with and visit websites programmatically. This is a\npowerful concept that has many uses.</p>\n<p><a href=\"https://codesandbox.io\">CodeSandbox</a> uses Puppeteer extensively nowadays. I\nwant to explain in 2 posts how we use Puppeteer. In this post I will explain why\nand how we use Puppeteer for our test suite. In the next post I will cover how\nwe use Puppeteer and\n<a href=\"https://martinfowler.com/articles/serverless.html\">serverless</a> functions to\ngenerate previews and metadata for sandboxes (projects).</p>\n<section>\n<h2 id=\"but-why\"><a href=\"#but-why\" aria-label=\"but why permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>But Why?</h2>\n<p>In CodeSandbox we do all bundling of the sandbox code in the browser,\n<a href=\"/post/creating-a-parallel-offline-extensible-browser-based-bundler-for-codesandbox\">I've built a custom bundler</a>\nto do this. We still make changes and add features to this bundler, so it's\ncrucial that we extensively test if the changes affect existing sandboxes built\nby users.</p>\n<h4 id=\"before\"><a href=\"#before\" aria-label=\"before permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Before</h4>\n<p>I've always kept a list of 'test' sandboxes and would load every sandbox\nmanually to see if they still worked. As you can probably expect, this proved to\nbe very time consuming as the list kept growing beyond 20 sandboxes and we\nstarted getting more contributions. Puppeteer to the rescue!</p>\n<h4 id=\"solution\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h4>\n<p>Puppeteer has a really nifty function called\n<a href=\"https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#pagescreenshotoptions\"><code class=\"language-text\">screenshot</code></a>\n(you can try it <a href=\"https://try-puppeteer.appspot.com\">here</a>). The function does\nexactly what it describes: it takes a screenshot of the current webpage and\nreturns the <code class=\"language-text\">Buffer</code> of the screenshot. For CodeSandbox we can use this as a\nsnapshot tool: after every commit we take a screenshot of all test sandboxes and\ncompare them with the previously stored screenshots. If there's a difference of\nmore than 1% we fail the test suite.</p>\n</section>\n<section>\n<h2 id=\"implementation\"><a href=\"#implementation\" aria-label=\"implementation permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Implementation</h2>\n<p>I decided to use <a href=\"https://github.com/facebook/jest\">Jest</a> for running all tests.\nWe start by setting up an array of sandboxes to test:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">SANDBOXES</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">'new'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'preact'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'vue'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'svelte'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'react-ts'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">'github/reactjs/redux/tree/master/examples/todomvc'</span><span class=\"token punctuation\">,</span> threshold<span class=\"token punctuation\">:</span> <span class=\"token number\">0.04</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">'jvlrl98xw3'</span><span class=\"token punctuation\">,</span> threshold<span class=\"token punctuation\">:</span> <span class=\"token number\">0.05</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// And moooore sandboxes</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre>\n      </div>\n<p>This is a list of sandbox ids, of which some have extra options like a more\ntolerant threshold. We iterate this list to create test cases:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">SANDBOXES</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sandboxes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">SANDBOXES</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sandbox</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> sandbox<span class=\"token punctuation\">.</span>id <span class=\"token operator\">||</span> sandbox<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> threshold <span class=\"token operator\">=</span> sandbox<span class=\"token punctuation\">.</span>threshold <span class=\"token operator\">||</span> <span class=\"token number\">0.01</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span>\n      <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">loads the sandbox with id '</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">'</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/* test code */</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token number\">120</span> <span class=\"token operator\">*</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n      </div>\n<p>The biggest question was how to take a screenshot of a single sandbox. This\nturned out to be quite simple, we already support opening a sandbox as a\nseparate page by going to <code class=\"language-text\">https://:id.codesandbox.io</code> (example:\n<a href=\"https://vue.codesandbox.io\">https://vue.codesandbox.io</a>). So the only thing\nleft for me was adding this functionality to the development server, so we can\ncreate screenshots with the new code. I ended up changing our <code class=\"language-text\">webpack</code> config\nto have a 'test' mode, this mode will only build the sandbox bundler and host it\nat <code class=\"language-text\">http://localhost:3001#:id</code> (example: <code class=\"language-text\">http://localhost:3001#vue</code>). Note that\nwe set the id as a hash, this way we don't interfere with the routing of the\nsandbox.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 740px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fa6bda478f6bdd1f025cb0c43e414818/8ff1e/0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABAElEQVQoz+2PQU+DQBCF99+Y0CZLraC7oIBWtLWXWnsxHozx5NkfXSgry+wSDBRxAI0HG/0B+g4vb5L5dt4SAJAyTdMXlBCi9zzPm6Z5+xRmUOrh6Xm+umf+1ZE/Y0HrBPe0yrUuXjsVRRvKskQgyzKlVNNJKb28fbxc3PnTZTC9OZutvPCaCJFEEazXuF9W1bau6y5UvX9dBjjg54Y9oSw0LW/MTqjNCDZOhNhsEhQWllJGUYQ5jmOtNZL4BMJpKm03pPzCOl3se/Mx853jgDQ/CmHs0n4BwOKTveHhYOQaI3dgukPqkJ3A9xFAfcAmNygzKDr/5fIu2OnJf/jPwO/P3aWfkB9+YwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A generated screenshot of a todo redux example\"\n        title=\"A generated screenshot of a todo redux example\"\n        src=\"/static/fa6bda478f6bdd1f025cb0c43e414818/bcf2d/0.png\"\n        srcset=\"/static/fa6bda478f6bdd1f025cb0c43e414818/d5c4a/0.png 185w,\n/static/fa6bda478f6bdd1f025cb0c43e414818/04e89/0.png 370w,\n/static/fa6bda478f6bdd1f025cb0c43e414818/bcf2d/0.png 740w,\n/static/fa6bda478f6bdd1f025cb0c43e414818/8ff1e/0.png 800w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>After having this set up it was fairly straightforward to build the rest.\nThere's already a library for comparing screenshots called\n<a href=\"https://github.com/americanexpress/jest-image-snapshot\"><code class=\"language-text\">jest-image-snapshot</code></a>.\nThis library exposes <code class=\"language-text\">toMatchImageSnapshot</code> on <code class=\"language-text\">expect</code>, which works almost\nexactly the same as <code class=\"language-text\">toMatchSnapshot</code>.</p>\n<p>The final implementation looks like this:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> puppeteer <span class=\"token keyword\">from</span> <span class=\"token string\">'puppeteer'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SANDBOXES</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token comment\">/* ids */</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">pageLoaded</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">page</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// We expose a function which the bundler will call after evaluation</span>\n    <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">exposeFunction</span><span class=\"token punctuation\">(</span><span class=\"token string\">'__puppeteer__'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sandboxes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> browser <span class=\"token operator\">=</span> puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    args<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'--no-sandbox'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'--disable-setuid-sandbox'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">afterAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token constant\">SANDBOXES</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sandbox</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> sandbox<span class=\"token punctuation\">.</span>id <span class=\"token operator\">||</span> sandbox<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> threshold <span class=\"token operator\">=</span> sandbox<span class=\"token punctuation\">.</span>threshold <span class=\"token operator\">||</span> <span class=\"token number\">0.01</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span>\n      <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">loads the sandbox with id '</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">'</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        browser <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> browser<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> browser<span class=\"token punctuation\">.</span><span class=\"token function\">newPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> waitFunction <span class=\"token operator\">=</span> <span class=\"token function\">pageLoaded</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// Go to the page</span>\n        page<span class=\"token punctuation\">.</span><span class=\"token function\">goto</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://localhost:3001/#'</span> <span class=\"token operator\">+</span> id<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          timeout<span class=\"token punctuation\">:</span> <span class=\"token number\">60000</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">await</span> waitFunction<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// Let fetch requests finish before continuing...</span>\n        <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">waitFor</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> screenshot <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">screenshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Check if the snapshot matches</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>screenshot<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMatchImageSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          customDiffConfig<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            threshold<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          customSnapshotIdentifier<span class=\"token punctuation\">:</span> id<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token number\">120</span> <span class=\"token operator\">*</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n      </div>\n<p>You can see in the code that we expose a function called <code class=\"language-text\">window.__puppeteer__</code>.\nThe bundler calls <code class=\"language-text\">window.__puppeteer__</code> when it's finished, this function is\nexposed by puppeteer so we can exactly know when we can take the screenshot. The\ngenerated screenshots are then saved in the <a href=\"https://github.com\">GitHub</a> repo.\nYou can find them\n<a href=\"https://github.com/codesandbox/codesandbox-client/blob/master/packages/app/integration-tests/tests/__image_snapshots__/\">here</a>.</p>\n<p>We run these tests using <a href=\"https://circleci.com\">CircleCI</a>, but we need to\ngenerate the initial screenshots locally. To ensure that we generate similar\nscreenshots as CircleCI we generate screenshots using a docker container. We\nhave a simple script which we just run to generate new screenshots:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-sh\"><code class=\"language-sh\">#!/bin/bash\ndocker run --rm --name test-container -v $(pwd):/home/circleci/codesandbox-client -w /home/circleci/codesandbox-client -d -t codesandbox/node-puppeteer yarn start:test &amp;&amp; \\\nsleep 6 &amp;&amp; docker exec -it test-container yarn test:integrations &amp;&amp; \\\ndocker stop test-container</code></pre>\n      </div>\n<p>I have set up a simple workflow for CircleCI to start the test server and\nsimultaneously run the tests. These tests are run in a docker container that has\nPuppeteer preinstalled.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 740px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d8afa3e049c40175c079362d315f2938/ff12a/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.868852459016395%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAA4klEQVQY042QPU7EMBCFfSNOQ78t56DjLlxgJToaREdDucWi1bIk/nnz48ROELNJhALFwifr+c3IM/bYXW9vr+5vNg93TdMgIef8eZFhGPq+K6Vq17nH/ct29/x0eBWRWmtfyjAuDNNa+zk8txjHUqvLSSSAfAIgEzyxbBdxkREpJQIxgZmmrGlikDVQIRHzsJyIqaxwLUerBFGD8IaPoEjKJ/gDtaTSlZ6znjgka5I1En4U62LUU9qjaQWB8Q4fOOk0gonK+RTLb9y3sycdybcUbRBTu0rlD9w6mH9pNvIPvgCjxMa60b2KiwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The workflow of CodeSandbox, notice the test-integrations step\"\n        title=\"The workflow of CodeSandbox, notice the test-integrations step\"\n        src=\"/static/d8afa3e049c40175c079362d315f2938/bcf2d/1.png\"\n        srcset=\"/static/d8afa3e049c40175c079362d315f2938/d5c4a/1.png 185w,\n/static/d8afa3e049c40175c079362d315f2938/04e89/1.png 370w,\n/static/d8afa3e049c40175c079362d315f2938/bcf2d/1.png 740w,\n/static/d8afa3e049c40175c079362d315f2938/dbb75/1.png 1110w,\n/static/d8afa3e049c40175c079362d315f2938/a808b/1.png 1480w,\n/static/d8afa3e049c40175c079362d315f2938/ff12a/1.png 1525w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>We save all diffs as artifacts, so we can easily compare the screenshots. You\ncan see a list of artifacts of a recent test run\n<a href=\"https://circleci.com/gh/codesandbox/codesandbox-client/4291#artifacts/containers/0\">here</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 740px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e1ea7c98fe34afda0dc9cc6a0e160585/8ff1e/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 225%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAtCAIAAAAhntw/AAAACXBIWXMAAAsSAAALEgHS3X78AAACqklEQVRIx+2V7U/aQBjA7/teBBlQWtDijDhgKxsWbEEBmQjohzl1SzYL8s6YibrsT56GggxoCy6oYw9XO2WaTb+YfeCX43juer+7a3LXB0mS1Go1m83vQKPRUOtOp9Pv939qQCzJcrbydW1rhwuvzoeSgzqcRDBOljuKcvIDc3IyCHq9HgjtdluW5T5GlpWND/n4+nYkvrGU3FxKvgutbKBG41gUpWoVxvdOT0/Pz8/VQK0vV25L7ELC5V/2cDGPL+TlFhkfh2DHsM96/RiAoNVqiaIIca1WUxQFTJgC5Gaz5V9MvAjE2eibV6E1Lxfhg2HU/ysgw14GryBJLPfa4fa7XgYHxRN0MwF0o3C9KUkyy2PZwzsZzslAzf9j5ZvkgGqO5P9UhrON5Xk4IU7wPQGYBXW7XbgM3Wt0NOCQwlURxdocF51xss+ez8+6/WpBlUrlk0ZZY3d3dw+zjzk4OKhUPjtczMSUg6BoM0WbSBoClB6wA+UqmUwml8sJggDPChgY8HTaYbdPk1baZqPtk3YjZQc5tS1kBCFfKOSBgvqnUcSUy6X0TmaKpHw04bWRDGFmrWaX1YhgHZg+lYKSSuMNqAtCM5vNggnTlYpFeEAS1lkr6aYnZqy2STPptFlQaRgY/UdT7YEXeWKiHuhMD8eJRwZiDGo9gYq3QJWNJkqnN+nHzTpcILiDDCuP6U06TdaN5HuW4QzmrpEfBp/ttMFIPtYZh2S4MV+GgZ79YaATLp+FovUGy6WsN6NqtXp0dHh4+G3w06jX67+v9MV9rtWE4l5ifdu/GPctxCH1QIDwlwCq3lXOzs7w10MG8yJLKp3Nj8XEWyGSgBS5FV19H4rdPktK0hy/7PRFGS7GsHfPkr5gjOFX2KV1nCXDgYXIXbIkP8qSI/l+5V+F8lsMC9UD4AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A diff artifact: the arrows are different\"\n        title=\"A diff artifact: the arrows are different\"\n        src=\"/static/e1ea7c98fe34afda0dc9cc6a0e160585/bcf2d/2.png\"\n        srcset=\"/static/e1ea7c98fe34afda0dc9cc6a0e160585/d5c4a/2.png 185w,\n/static/e1ea7c98fe34afda0dc9cc6a0e160585/04e89/2.png 370w,\n/static/e1ea7c98fe34afda0dc9cc6a0e160585/bcf2d/2.png 740w,\n/static/e1ea7c98fe34afda0dc9cc6a0e160585/8ff1e/2.png 800w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n</section>\n<section>\n<h2 id=\"conclusion\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>The implementation turned out to be quite simple, but it has saved me a lot of\ntime already. We now test a little over 20 sandboxes for every commit and PR. I\nalso noticed that I'm more inclined to add sandboxes to the test suite too,\nwhich made the bundler more stable in general.</p>\n<hr>\n<p>In the next post I will cover how we use Puppeteer with serverless functions to\ngenerate metadata and oEmbed tags for sandboxes. You can follow my Twitter\n<a href=\"https://twitter.com/CompuIves\">@CompuIves</a> or\n<a href=\"https://twitter.com/codesandbox\">@codesandbox</a> to stay up to date!</p>\n<p>If you're interested in the code; all code that was described here (and of\nCodeSandbox) is open source on GitHub. You can find the main repository\n<a href=\"https://github.com/codesandbox/codesandbox-client\">here</a>.</p>\n<p>I hope you found the post interesting, don't hesitate to respond with more ideas\nand uses for Puppeteer!</p>\n</section>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"b6e6d9a5-edb2-514a-ae79-d5e998505f1e"}}}